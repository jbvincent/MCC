rm(list=ls())

setwd("/Users/JBVincent/Desktop/post_doc/MCC")

##packages
library(vegan)
library(ggplot2)
library(tidyr)
library(fossil)
library(dplyr)
library(stringr)
library(boot)
library(magrittr)
library(reshape2)
library(purrr)
library(labdsv)
library(gdata)
library(plyr)


##read in data

MCC_pilot_data<-read.table("MCC_data.txt",header=TRUE)
str(MCC_pilot_data)

##unpeel comm matrix and split master id (plot_year) into two columns

MCC_pilot_data_melted<-melt(MCC_pilot_data)

MCC_pilot_data_melted<-MCC_pilot_data_melted%>%separate(master_ID, c("plot", "year"), "_")


##split into list 
plots<-unique(MCC_pilot_data_melted$plot)
MCC_split_list<-split( MCC_pilot_data_melted , MCC_pilot_data_melted$plot)

#make matrices for each plot

MCC_split_list<-lapply(MCC_split_list, function(x) { x[2:4] })

MCC_matrix_list<-lapply(MCC_split_list,matrify)

MCC_dist_list<-lapply(MCC_matrix_list,vegdist)

MCC_dist_list<-lapply(MCC_dist_list,as.matrix)

##off diag - relative to previous year

MCC_dist_list_off_diag<-lapply(MCC_dist_list,function(x) {cbind(x[row(x) == (col(x) + 1)],x[-1,0],colnames(x))})

MCC_dist_list_off_diag<-lapply(MCC_dist_list_off_diag,as.data.frame)

MCC_dist_list_off_diag<-lapply(MCC_dist_list_off_diag,add_rownames)

MCC_off_diag_compiled<-ldply(MCC_dist_list_off_diag)

MCC_off_diag_compiled$V1<-as.numeric(as.character(MCC_off_diag_compiled$V1))

MCC_off_diag_compiled<-plyr::rename(MCC_off_diag_compiled,c(".id"="plot","rowname"="current","V1"="dist","V2"="previous"))

MCC_off_diag_compiled$current<-as.numeric(as.character(MCC_off_diag_compiled$current))

MCC_off_diag_compiled <- MCC_off_diag_compiled[which(MCC_off_diag_compiled$current > 2),]

##plotting

MCC_off_diag_years<-unique(MCC_off_diag_compiled$current)

base_off_diag_MCC<-ggplot(MCC_off_diag_compiled,aes(x=as.numeric(current),y=dist,group=plot))+geom_line()+theme_bw()+ylab("Bray-Curtis Dissimilarity")+xlab("Year")+scale_x_continuous(breaks=MCC_off_diag_years)+theme(panel.grid.minor = element_blank())

##botstrapping for loop

boot_plot<-c()
boot_mean<-c()
boot_5<-c()
boot_95<-c()
for (i in 1:length(MCC_off_diag_years){
temp1<-MCC_off_diag_compiled[which(MCC_off_diag_compiled$plot==MCC_off_diag_years[i]






#first row - relative to starting condition (without labels)

MCC_dist_list_first_column<-lapply(MCC_dist_list,function(x) {x[,1]})

MCC_first_column_compiled<-as.data.frame(flatten(MCC_dist_list_first_column))

MCC_first_column_compiled$key <- rownames(MCC_first_column_compiled)

MCC_first_column_compiled<-MCC_first_column_compiled%>%separate("key", c("plot", "year"))

MCC_first_column_compiled<-subset(MCC_first_column_compiled, year!="NA")

MCC_first_column_compiled<-plyr::rename(MCC_first_column_compiled, c("flatten(MCC_dist_list_first_column)" = "value"))



#add in base year

base_years<-MCC_first_column_compiled[which(MCC_first_column_compiled$value==0),]

base_years<-base_years[,2:3]

base_years<-plyr::rename(base_years, c("year" = "base_year"))

MCC_first_column_compiled<-subset(MCC_first_column_compiled, value!=0)

MCC_first_column_compiled2<-merge(MCC_first_column_compiled,base_years,by="plot",all.x=TRUE)

#plotting

base_first_column_MCC<-ggplot(MCC_first_column_compiled2,aes(x=as.numeric(year),y=value,group=plot))+geom_line()+theme_bw()+ylab("Bray-Curtis Dissimilarity")+xlab("Year")+scale_x_continuous(breaks=as.numeric(MCC_first_column_breaks))+theme(panel.grid.minor = element_blank())

